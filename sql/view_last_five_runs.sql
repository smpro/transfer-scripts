create or replace view view_last_five_runs as
SELECT * FROM (
  SELECT 
       TO_CHAR(RUNNUMBER)                             AS RUN_NUMBER,
       TO_CHAR( MIN ( CTIME ), 'YYYY/MM/DD HH24:MI' ) AS START_TIME,
       TO_CHAR ( MIN(SETUPLABEL) )                    AS SETUPLABEL,
       TO_CHAR ( ROUND ( SUM ( FILESIZE ) / 1073741824,
                         2 ) ) || ' GB'               AS TOTAL_SIZE,
       TO_CHAR(SUM(NEVENTS))                          AS NEVTS,
       TO_CHAR(COUNT(*))                              AS NFILES,
       RATE_AVERAGE(RUNNUMBER)                        AS RATE_AVG,
       TO_CHAR(COUNT(*)-COUNT(FILESIZE))              AS N_OPEN,
       TO_CHAR(COUNT(FILESIZE))                       AS N_CLOSED,
       TO_CHAR(COUNT(FILES_TRANS_COPIED.FILENAME))    AS N_SAFE0,
       TO_CHAR(COUNT(FILES_TRANS_CHECKED.FILENAME))   AS N_SAFE99,
       TO_CHAR(COUNT(FILES_DELETED.FILENAME))         AS N_DELETED
       FROM FILES_CREATED LEFT OUTER JOIN FILES_INJECTED on FILES_CREATED.FILENAME = FILES_INJECTED.FILENAME
                          LEFT OUTER JOIN FILES_TRANS_COPIED on FILES_CREATED.FILENAME = FILES_TRANS_COPIED.FILENAME
                          LEFT OUTER JOIN FILES_TRANS_CHECKED on FILES_CREATED.FILENAME = FILES_TRANS_CHECKED.FILENAME
                          LEFT OUTER JOIN FILES_DELETED on FILES_CREATED.FILENAME = FILES_DELETED.FILENAME
  WHERE PRODUCER='StorageManager'
  GROUP BY RUNNUMBER
  ORDER BY -RUNNUMBER
)
WHERE ROWNUM < 6;




grant select on view_last_five_runs to public;
