create or replace view view_closed as
SELECT 'Number of closed files' AS DESCRIPTION,
       TO_CHAR ( COUNT ( * ) ) AS COUNT
  FROM FILES_INJECTED JOIN FILES_CREATED ON FILES_INJECTED.FILENAME = FILES_CREATED.FILENAME
   WHERE PRODUCER='StorageManager'
 UNION SELECT 'Number of files (safety > 0)' AS DESCRIPTION,
       TO_CHAR ( COUNT ( * ) ) AS COUNT
  FROM FILES_TRANS_COPIED JOIN FILES_CREATED ON FILES_TRANS_COPIED.FILENAME = FILES_CREATED.FILENAME
   WHERE PRODUCER='StorageManager'
 UNION SELECT 'Number of files (safety > 99)' AS DESCRIPTION,
       TO_CHAR ( COUNT ( * ) ) AS COUNT
  FROM FILES_TRANS_CHECKED JOIN FILES_CREATED ON FILES_TRANS_CHECKED.FILENAME = FILES_CREATED.FILENAME
   WHERE PRODUCER='StorageManager'
 UNION SELECT 'Total size of closed files' AS DESCRIPTION,
       TO_CHAR ( ROUND ( SUM ( FILESIZE ) / 1073741824,
			 2 ) ) || ' GB' AS COUNT
  FROM FILES_INJECTED JOIN FILES_CREATED ON FILES_INJECTED.FILENAME = FILES_CREATED.FILENAME
   WHERE PRODUCER='StorageManager'
 UNION SELECT 'Total size of files (safety > 0)' AS DESCRIPTION,
       TO_CHAR ( ROUND ( SUM ( FILESIZE ) / 1073741824,
			 2 ) ) || ' GB' AS COUNT
  FROM FILES_INJECTED 
    JOIN FILES_TRANS_COPIED ON FILES_INJECTED.FILENAME = FILES_TRANS_COPIED.FILENAME
    JOIN FILES_CREATED ON FILES_INJECTED.FILENAME = FILES_CREATED.FILENAME
   WHERE PRODUCER='StorageManager'
 UNION SELECT 'Total size of files (safety > 99)' AS DESCRIPTION,
       TO_CHAR ( ROUND ( SUM ( FILESIZE ) / 1073741824,
			 2 ) ) || ' GB' AS COUNT
  FROM FILES_INJECTED
    JOIN FILES_TRANS_CHECKED ON FILES_INJECTED.FILENAME = FILES_TRANS_CHECKED.FILENAME
    JOIN FILES_CREATED ON FILES_INJECTED.FILENAME = FILES_CREATED.FILENAME
   WHERE PRODUCER='StorageManager'
 UNION SELECT 'Oldest closed file Run Number' AS DESCRIPTION,
       TO_CHAR ( RUNNUMBER ) AS COUNT
  FROM FILES_CREATED
 WHERE CTIME = ( SELECT MIN ( CTIME )
		        FROM FILES_CREATED JOIN FILES_INJECTED on FILES_INJECTED.FILENAME = FILES_CREATED.FILENAME
                          WHERE PRODUCER='StorageManager')
   AND PRODUCER='StorageManager'
UNION SELECT 'Oldest closed file Start Time' AS DESCRIPTION,
       TO_CHAR ( MIN (CTIME) , 'YYYY/MM/DD HH24:MI' ) AS COUNT
  FROM FILES_CREATED JOIN FILES_INJECTED on FILES_INJECTED.FILENAME = FILES_CREATED.FILENAME
    WHERE PRODUCER='StorageManager';
 
grant select on view_closed to public;
